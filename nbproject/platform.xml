<project name="platform" default="download" basedir="..">
    <target name="check-download">
        <echo message="Invoked tasks: ${ant.project.invoked-targets}"/>
        <condition property="download.required">
            <and>
                <not>
                    <available file="${harness.dir}/suite.xml"/>
                </not>
                <isset property="bootstrap.url"/>
                <isset property="autoupdate.catalog.url"/>
                <isset property="autoupdate_certified.catalog.url"/>
                <not>
                    <contains substring="clean" string="${ant.project.invoked-targets}"/>
                </not>
            </and>
        </condition>
    </target>
    <target name="download" if="download.required" depends="check-download">
        <mkdir dir="${harness.dir}"/>
        <pathconvert pathsep="|" property="download.clusters">
            <mapper type="flatten"/>
            <path path="${cluster.path}"/>
        </pathconvert>
        <property name="disabled.modules" value=""/>
        <pathconvert property="module.includes" pathsep="">
            <mapper type="glob" from="${basedir}${file.separator}*" to="(?!\Q*\E)"/>
            <path>
                <filelist files="${disabled.modules}" dir="."/>
            </path>
        </pathconvert>
        <property name="module.force.includes" value=""/>
        <pathconvert property="enforced.modules" pathsep="">
            <mapper type="glob" from="${basedir}${file.separator}${enforced.modules}" to="(?!\Q*\E)"/>
            <path>
                <filelist files="${module.force.includes}" dir="."/>
            </path>
        </pathconvert>
        <echo message="Downloading clusters ${download.clusters}"/>
        <echo message="Enforcing modules ${enforced.modules}"/>
        <property name="tasks.jar" location="${java.io.tmpdir}/tasks.jar"/>
        <get src="${bootstrap.url}" dest="${tasks.jar}" usetimestamp="true" verbose="true"/>
        <taskdef name="autoupdate" classname="org.netbeans.nbbuild.AutoUpdate" classpath="${tasks.jar}"/>
        <autoupdate installdir="${nbplatform.active.dir}" updatecenter="${autoupdate.catalog.url}">
            <modules  includes="${module.includes}.*" clusters="${download.clusters}"/>
            <modules includes="${module.force.includes}.*" clusters="${download.clusters}"/>
            <modules includes="org[.]netbeans[.]modules[.]apisupport[.]harness" clusters="harness"/>
        </autoupdate>
        <autoupdate installdir="${nbplatform.active.dir}" updatecenter="${autoupdate_certified.catalog.url}">
            <modules includes="${module.includes}.*" clusters="${download.clusters}"/>
            <modules includes="org[.]netbeans[.]modules[.]apisupport[.]harness" clusters="harness"/>
        </autoupdate>
    </target>
</project>